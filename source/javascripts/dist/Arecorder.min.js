var app=angular.module("Arecorder",["ngResource","ngRoute","ui.bootstrap","ngAnimate","ngFileUpload"]);app.config(["$routeProvider",function(e){e.when("/",{templateUrl:"partials/index.html",controller:"IndexCtrl"}).when("/home",{templateUrl:"partials/home.html",controller:"HomeCtrl"}).when("/profile/:username",{templateUrl:"partials/profile.html",controller:"ProfileCtrl"}).otherwise({redirectTo:"/home"})}]),app.controller("IndexCtrl",["$scope","$resource","$location","$window","$rootScope","$uibModal","$timeout",function(e,t,n,s,o,a,i){e.height=s.innerHeight,e.width=s.innerWidth;var r=t("/api/users");r.get(function(e){e.msg||(o.alerts=[{type:"danger",msg:"你已经登陆了，正在前往作业页面……"}],i(function(){o.alerts=[],n.path("/home")},2e3))}),e.openLogin=function(){var e=a.open({animation:!0,templateUrl:"partials/login.html",controller:"LoginCtrl"});e.result.then(function(e){KM.EventUtil.removeEventListener(window,"keypress",e.handler)},function(e){KM.EventUtil.removeEventListener(window,"keypress",e.handler),o.alerts=[]})},e.openSignup=function(){var e=a.open({animation:!0,templateUrl:"partials/signup.html",controller:"SignupCtrl"});e.result.then(function(e){KM.EventUtil.removeEventListener(window,"keypress",e.handler)},function(e){KM.EventUtil.removeEventListener(window,"keypress",e.handler),o.alerts=[]})}}]),app.controller("HomeCtrl",["$scope","$resource","$location","$window","$rootScope","$uibModal","$timeout",function(e,t,n,s,o,a,r){var u=4,l=2;e.height=s.innerHeight,e.width=s.innerWidth,e.status=!0,e.firstStatus=!1,e.assignments=[];var c=t("/api/users");c.get(function(t){t.msg?(o.alerts=[{type:"danger",msg:"你还没登陆，正在返回主页……"}],r(function(){o.alerts=[],n.path("/")},2e3)):(o.username=t.username,e.refresh(),e.status=!1)}),e.logout=function(){var s=e.logout;e.logout=function(){};var a=t("/api/users/logout");a.get(function(t){o.alerts=[{type:"success",msg:t.msg}],r(function(){e.logout=s,o.alerts=[],n.path("/")},2e3)})},e.openEdit=function(t){o.id=t;var n=a.open({animation:!0,templateUrl:"partials/form.html",controller:"EditAssignmentCtrl"});n.result.then(function(){e.refresh()})},e.openDelete=function(t){o.id=t;var n=a.open({animation:!0,templateUrl:"partials/delete.html",controller:"DeleteAssignmentCtrl"});n.result.then(function(){u-=1,e.refresh()})},e.openAdd=function(){var t=a.open({animation:!0,templateUrl:"partials/form.html",controller:"AddAssignmentCtrl"});t.result.then(function(t){"redirect"===t?(o.alerts=[{type:"danger",msg:"你都还没登陆添加啥作业！"}],r(function(){o.alerts=[],e.openLogin()},2e3)):e.refresh()})},e.nextPage=function(){if(!this.busy){e.busy=!0;var n=t("/api/assignments/:num"),s=u;u+=l,n.query({num:u},function(t){if(e.assignments.length===t.length)e.noMore=!0,r(function(){e.noMore=!1},2e3);else{for(var n=0;n<t.length;n++){var o=t[n].date.split("-"),a=o[0],i=o[1],u=o[2],c=new Date;a<c.getFullYear()?t[n].submit=!0:a==c.getFullYear()&&(i<c.getMonth()+1?t[n].submit=!0:i==c.getMonth()+1&&u<c.getDate()&&(t[n].submit=!0))}for(n=0;l>n;n++)t[s+n]&&e.assignments.push(t[s+n])}e.busy=!1})}},e.refresh=function(){var n=t("/api/assignments/:num");n.query({num:u},function(t){if(0===t.length)e.firstStatus=!0,e.assignments=[],document.querySelector(".assignmentContainer").classList.add("center");else{for(e.firstStatus=!1,i=0;i<t.length;i++){var n=t[i].date.split("-"),s=n[0],o=n[1],a=n[2],r=new Date;s<r.getFullYear()?t[i].submit=!0:s==r.getFullYear()&&(o<r.getMonth()+1?t[i].submit=!0:o==r.getMonth()+1&&a<r.getDate()&&(t[i].submit=!0))}e.assignments=t,document.querySelector(".assignmentContainer").classList.remove("center")}})},e.update=function(e){var n=t("/api/assignments/edit/:id",{id:"@_id"},{update:{method:"PUT"}});n.update(e,function(){})}}]),app.controller("ProfileCtrl",["$scope","$resource","$routeParams","$location","$timeout","Upload","$rootScope",function(e,t,n,s,o,a,i){e.status=!0;var r=t("/api/profiles/:username",{username:"@username"},{update:{method:"PUT"}});e.refresh=function(){r.get({username:n.username},function(t){t.msg?(i.alerts=[{type:"danger",msg:t.msg}],o(function(){i.alerts=[],s.path("/")},2e3)):e.profile=t})},e.refresh(),e.update=function(t){r.update(e.profile,function(n){"success"===n.status?t?t.upload=a.upload({url:"/upload/avatar",data:{avatar:t}}).then(function(t){"success"===t.data.status?(e.msg="更新成功",e.status=!0,o(function(){e.status=!1},2e3)):(e.msg="资料更新成功，头像上传失败",e.status=!0,o(function(){e.status=!1},2e3))}):(e.msg="更新成功",e.status=!0,o(function(){e.status=!1},2e3)):(e.msg="更新失败",e.status=!0,o(function(){e.status=!1},2e3)),e.refresh()})},e.goBack=function(){s.path("/home")}}]),app.controller("AddAssignmentCtrl",["$scope","$resource","$location","$uibModalInstance","Upload","$rootScope","$timeout",function(e,t,n,s,o,a,i){e.save=function(n){var r=t("/api/assignments");r.save(e.assignment,function(e){e.msg?s.close("redirect"):n?n.upload=o.upload({url:"/upload/file",data:{fileId:e._id,file:n}}).then(function(e){"success"===e.data.status?s.close("success"):(a.alerts=[{type:"danger",msg:"文件上传不成功，请重试"}],i(function(){a.alerts=[]},2e3))}):s.close("success")})},e.cancel=function(){s.dismiss("cancel")}}]),app.controller("EditAssignmentCtrl",["$scope","$resource","$location","$rootScope","$uibModalInstance","Upload","$timeout",function(e,t,n,s,o,a,i){var r=t("/api/assignments/edit/:id",{id:"@_id"},{update:{method:"PUT"}});r.get({id:s.id},function(t){var n=t.date.split("-"),s=n[0],o=n[1],a=n[2],i=new Date;s<i.getFullYear()?t.submit=!0:s==i.getFullYear()&&(o<i.getMonth()+1?t.submit=!0:o==i.getMonth()+1&&a<i.getDate()&&(t.submit=!0)),n=new Date(s,o-1,a),t.date=n,e.assignment=t}),e.save=function(t){r.update(e.assignment,function(){t&&(t.upload=a.upload({url:"/upload/file",data:{fileId:e.assignment._id,file:t}}).then(function(e){"success"===e.data.status&&o.close("success")})),o.close("success")})},e.cancel=function(){o.dismiss("cancel")}}]),app.controller("DeleteAssignmentCtrl",["$scope","$resource","$location","$rootScope","$uibModalInstance","$window","$timeout",function(e,t,n,s,o,a,i){var r=t("/api/assignments/delete/:id");e["delete"]=function(){r["delete"]({id:s.id},function(e){o.close("success")})},e.cancel=function(){o.dismiss("cancel")}}]),app.controller("SignupCtrl",["$scope","$resource","$location","$uibModalInstance","$rootScope","$timeout",function(e,t,n,s,o,a){var i=function(e){KM.EventUtil.fixEvent(e);13!==e.which||document.querySelector(".btn-submit").disabled||document.querySelector(".btn-submit").click()};KM.EventUtil.addEventListener(window,"keypress",i),e.signup=function(){document.querySelector(".btn-submit").disabled=!0;var n=t("/api/users/signup");n.save(e.user,function(e){if("fail"==e.status)o.alerts=[{type:"danger",msg:e.msg}],a(function(){document.querySelector(".btn-submit").disabled=!1,o.alerts=[]},2e3);else{o.alerts=[{type:"success",msg:"注册成功，请登录"}],a(function(){o.alerts=[]},2e3);var t={handler:i,status:"success"};s.close(t)}})},e.cancel=function(){var e={handler:i,status:"cancel"};s.dismiss(e)},e.check=function(){document.querySelector(".has-feedback").classList.add("ajaxing");var n=t("/api/users/signup");n.get(e.user,function(e){document.querySelector(".has-feedback").classList.remove("ajaxing"),"success"===e.status?document.querySelector(".has-feedback").classList.add("has-success"):document.querySelector(".has-feedback").classList.add("has-error")})},e.removeStatus=function(){document.querySelector(".has-feedback").classList.remove("has-error"),document.querySelector(".has-feedback").classList.remove("has-success")}}]),app.controller("LoginCtrl",["$scope","$resource","$location","$rootScope","$uibModalInstance","$window","$timeout",function(e,t,n,s,o,a,i){var r=function(e){KM.EventUtil.fixEvent(e);13!==e.which||document.querySelector(".btn-submit").disabled||document.querySelector(".btn-submit").click()};KM.EventUtil.addEventListener(window,"keypress",r),e.login=function(){document.querySelector(".btn-submit").disabled=!0;var a=t("/api/users/login");a.save(e.user,function(e){if("fail"==e.status)s.alerts=[{type:"danger",msg:e.msg}],i(function(){document.querySelector(".btn-submit").disabled=!1,s.alerts=[]},2e3);else{s.alerts=[{type:"success",msg:"欢迎回来："+e.name+"。正在进入作业页面..."}];var t={handler:r,status:"success"};o.close(t),i(function(){s.alerts=[],n.path("/home")},2e3)}})},e.cancel=function(){var e={handler:r,status:"cancel"};o.dismiss(e)}}]);